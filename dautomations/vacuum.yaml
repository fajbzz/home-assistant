- id: '1644566778718'
  alias: Støvsug Mandag og Fredag når ingen er hjemme
  description: ''
  trigger:
  - platform: time
    at: '14:00'
    id: cleaningtime
  - platform: template
    value_template: >
      {{ states('binary_sensor.anyone_home') == 'off' 
         and now().timestamp() - as_timestamp(states.binary_sensor.anyone_home.last_changed) > 1800 }}
    id: hjemmealene
  - platform: state
    entity_id: vacuum.martin
    from: 'cleaning'
    id: done_cleaning
  - platform: template
    value_template: >
      {{ states('binary_sensor.anyone_home') == 'on' }}
    id: noenkommerhjem
  condition: []
  action:
  - choose:
    - conditions:
      - condition: trigger
        id: done_cleaning
      sequence:
      - service: input_datetime.set_datetime
        data:
          timestamp: '{{ now().timestamp() }}'
        target:
          entity_id: input_datetime.vacuum_last_on
    - conditions:
      - condition: or
        conditions:
        - condition: trigger
          id: hjemmealene
        - condition: and
          conditions: 
          - condition: trigger
            id: cleaningtime
          - condition: template
            value_template: >
              {{ states('binary_sensor.anyone_home') == 'off' 
                 and now().timestamp() - as_timestamp(states.binary_sensor.anyone_home.last_changed) > 1800 }}
          - condition: template
            value_template: >
                {{ now().timestamp() - as_timestamp(states('input_datetime.vacuum_last_on')) > 86400 }}
      - condition: or
        conditions:
        - condition: time
          after: '13:00'
          before: '14:15'
          weekday:
          - mon
          - fri
        - condition: template
          value_template: >
            {{ now().timestamp() - as_timestamp(states('input_datetime.vacuum_last_on')) > 345600 }}
      - condition: device
        device_id: 22bed80b6a2c686ba9af11178f87dc16
        domain: vacuum
        entity_id: vacuum.martin
        type: is_docked
      sequence:
      - device_id: 22bed80b6a2c686ba9af11178f87dc16
        domain: vacuum
        entity_id: vacuum.martin
        type: clean
    - conditions:
      - condition: trigger
        id: noenkommerhjem
      sequence:
      - choose:
        - conditions:
          - condition: device
            device_id: 22bed80b6a2c686ba9af11178f87dc16
            domain: vacuum
            entity_id: vacuum.martin
            type: is_cleaning
          sequence:
          - service: vacuum.pause
            data: {}
            target:
              device_id: 22bed80b6a2c686ba9af11178f87dc16
          - wait_template: "{{ states('vacuum.martin') == 'paused' }}"
            continue_on_timeout: true
            timeout: "60"
          - service: vacuum.return_to_base
            data: {}
            target:
              entity_id: vacuum.martin
        - conditions:
          - condition: state
            entity_id: vacuum.martin
            state: error
          sequence:
          - delay:
              hours: 0
              minutes: 2
              seconds: 0
              milliseconds: 0
          - service: media_player.volume_set
            data:
              volume_level: 0.3
            target:
              entity_id: media_player.stue
          - service: tts.google_translate_say
            data:
              entity_id: media_player.stue
              language: 'no'
              message: 'Hei, og velkommen hjem. Jeg har forsøkt å støvsuge, men har
                satt meg fast. Kan du hjelpe meg ? '
          - delay:
              hours: 0
              minutes: 0
              seconds: 10
              milliseconds: 0
          - service: vacuum.locate
            data: {}
            target:
              entity_id: vacuum.martin
        default: []
    default: []
  mode: single
